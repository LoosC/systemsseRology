---
title: "Comparison of correlation matrices"
---

Get the correlation matrices including p-values

```{r heatmap}
library(Hmisc)

# cor1 <- rcorr(X1, type = "spearman")
# cor2 <- rcorr(X2, type = "spearman")

p <- corrplot(cor1$r, method = "color", tl.col = "black", tl.cex = 0.5)
p <- corrplot(cor2$r, method = "color", tl.col = "black", tl.cex = 0.5)
```

Mantel test (I do not trust this test that much...)

```{r mantel}
library(ade4)
mantel.rtest(as.dist(cor1$r), as.dist(cor2$r), nrepet = 10000)
```

Compare (visually) histogram over correlation coefficients and p-values

```{r histogram}
library(ggplot)
dfHist <- data.frame(corMat = rep(c("1", "2"), c(length(cor1$r[upper.tri(cor1$r)]), 
                                  length(cor2$r[upper.tri(cor2$r)]))),
                     cors = c(cor1$r[upper.tri(cor1$r)], cor2$r[upper.tri(cor2$r)]),
                     pvals = c(cor1$P[upper.tri(cor1$r)], cor2$P[upper.tri(cor2$r)]))

ggplot(dfHist, aes(x = cors, fill = corMat)) +
  geom_histogram(alpha = 0.5, position = "identity") +
  theme_classic() + 
  theme(legend.position = "top")

ggplot(dfHist, aes(x = pvals, fill = corMat)) +
  geom_histogram(alpha = 0.5, position = "identity") +
  theme_classic() + 
  theme(legend.position = "top")
```

Are the correlations (rank-)correlated?

```{r cortest}
tmp <- cor.test(cor1$r[upper.tri(cor1$r)], cor2$r[upper.tri(cor2$r)], method = "spearman")
```

Network properties analysis

```{r network1}
library(tidyverse)
library(corrr)
library(igraph)
library(ggraph)
library(ggrepel)
library(RColorBrewer)

tidyCors <- X1 %>% 
  correlate(method = "spearman") %>% 
  stretch()

tidyCors$p <- 0
for (ind in 1:dim(tidyCors)[1]) {
  tmp <- cor.test(X[,tidyCors$x[ind]], X[,tidyCors$y[ind]], method = "spearman")
  tidyCors$p[ind] <- tmp$p.value
}
tidyCors$p <- p.adjust(tidyCors$p, method = "BH", n = length(tidyCors$p))
  
graphCors <- tidyCors %>% 
  filter(p < 0.05) %>% 
  graph_from_data_frame(directed = FALSE)

layout <- create_layout(graphCors, layout = 'igraph', algorithm = 'circle')

graph1 <- ggraph(layout) +
  geom_edge_link(aes(color = r), edge_width = 0.8) +
  guides(edge_alpha = "none", edge_width = "none") +
  scale_edge_colour_gradientn(limits = c(-1, 1), 
                              colors = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100)) +
  geom_node_point(shape = 21, color = "gray", fill = "white", size = 8, stroke = 0.5) +
  geom_node_text(aes(label = name), size = 3, repel = T) +
  theme(aspect.ratio = 1) +
  theme_graph(background = "white", base_family = 'Helvetica') 
plt <- plot(graph1)

```

```{r network2}
tidyCors <- X2 %>% 
  correlate(method = "spearman") %>% 
  stretch()

tidyCors$p <- 0
for (ind in 1:dim(tidyCors)[1]) {
  tmp <- cor.test(X[,tidyCors$x[ind]], X[,tidyCors$y[ind]], method = "spearman")
  tidyCors$p[ind] <- tmp$p.value
}
tidyCors$p <- p.adjust(tidyCors$p, method = "BH", n = length(tidyCors$p))
  
graphCors <- tidyCors %>% 
  filter(p < 0.05) %>% 
  graph_from_data_frame(directed = FALSE)

layout <- create_layout(graphCors, layout = 'igraph', algorithm = 'circle')

graph2 <- ggraph(layout) +
  geom_edge_link(aes(color = r), edge_width = 0.8) +
  guides(edge_alpha = "none", edge_width = "none") +
  scale_edge_colour_gradientn(limits = c(-1, 1), 
                              colors = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100)) +
  geom_node_point(shape = 21, color = "gray", fill = "white", size = 8, stroke = 0.5) +
  geom_node_text(aes(label = name), size = 3, repel = T) +
  theme(aspect.ratio = 1) +
  theme_graph(background = "white", base_family = 'Helvetica') 
plt <- plot(graph2)
```

I found that the package qgraph might be better for the analysis. Still need to think about what thresholds to use (for pvalues - multiple testing etc) to remove non-significant edges. I do not trust their evaluation of significance, maybe needs a workaround.

http://sachaepskamp.com/files/Cookbook.html

Different modules might be connected in the different correlation matrices, showing different mechanisms?

```{r comparenetworks}
library(qgraph)
tmp1 <- cor1$r
tmp2 <- cor2$r


qgraph1 <- qgraph(tmp1, graph = "cor", layout = "spring", label.cex = 0.5, minimum = 0.001, maximum = 1,
                     label.scale = FALSE, label.scale.equal = TRUE, labels = colnames(cor1$r))
qgraph2 <- qgraph(tmp2, graph = "cor", layout = "spring", label.cex = 0.5, minimum = 0.001, maximum = 1,
                     label.scale = FALSE, label.scale.equal = TRUE, labels = colnames(cor2$r))

# Make same layout for the two graphs to make it more comparable
Layout <- averageLayout(qgraph1, qgraph2)
qgraph1 <- qgraph(tmp1, graph = "cor", layout = Layout, label.cex = 0.5,minimum = 0.001, maximum = 1,
                     label.scale = FALSE, label.scale.equal = TRUE, labels = colnames(cor1$r))
qgraph2 <- qgraph(tmp2, graph = "cor", layout = Layout, label.cex = 0.5,minimum = 0.001, maximum = 1,
                     label.scale = FALSE, label.scale.equal = TRUE, labels = colnames(cor2$r))


centralityPlot(comp = list(gr1 = qgraph1, gr2 = qgraph2), include = c("all"),
               orderBy = "Strength")
```
